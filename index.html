<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dobby ‚Äî Smart Movie Assistant</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:Arial,system-ui;}
#app{max-width:900px;margin:auto;padding:20px}
#chat{border:1px solid #333;border-radius:10px;padding:10px;height:260px;overflow-y:auto;background:#111}
#results{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:10px}
.movie{background:#1c1c1c;border-radius:8px;overflow:hidden;position:relative}
.movie img{width:100%;height:240px;object-fit:cover}
.movie div{padding:8px;font-size:.9rem}
.heart{position:absolute;top:8px;right:8px;font-size:20px;cursor:pointer;filter:drop-shadow(0 0 6px #000)}
.heart.liked{color:#ff3b7b}
input,button{padding:10px;border-radius:8px;border:none}
#inputRow{display:flex;gap:8px;margin-top:12px}
button{background:#00ffc8;font-weight:bold;cursor:pointer}
</style>
</head>
<body>
<div id="app">

<h2>Dobby ‚Äî Your AI Movie Assistant üé¨</h2>

<div id="chat"></div>

<div id="inputRow">
  <input id="userInput" placeholder="Ask e.g. 'best korean action 2018 8+'">
  <button id="send">Ask</button>
</div>

<div id="results"></div>

</div>

<script>
// ====== CONFIG ======
const FIREWORKS_KEY = "fw_3ZGLzhbzx5RjAdU8mNQt4ZNb";
const FIREWORKS_MODEL = "accounts/fireworks/models/llama-v3p1-70b-instruct";

let CATALOG = [];
let favorites = new Set(JSON.parse(localStorage.getItem("favorites")||"[]"));
let RANK_CACHE = {};

// ====== UI ======
function chat(role, text){
  const box=document.getElementById("chat");
  box.innerHTML+=`<p><b>${role}:</b> ${text}</p>`;
  box.scrollTop=box.scrollHeight;
}

function showMovies(list){
  const box=document.getElementById("results");
  box.innerHTML="";
  list.slice(0,10).forEach(m=>{
    const liked = favorites.has(m.id) ? "liked" : "";
    box.innerHTML+=`
      <div class="movie">
        <span class="heart ${liked}" data-id="${m.id}">‚ù§Ô∏è</span>
        <img src="${m.primaryImage||''}">
        <div>${m.primaryTitle||m.title||''}<br>‚≠ê ${m.averageRating||"N/A"}</div>
      </div>
    `;
  });

  document.querySelectorAll(".heart").forEach(h=>{
    h.onclick=()=>{
      const id=h.dataset.id;
      if(favorites.has(id)){ favorites.delete(id); h.classList.remove("liked"); }
      else{ favorites.add(id); h.classList.add("liked"); }
      localStorage.setItem("favorites",JSON.stringify([...favorites]));
    };
  });
}

// ====== LOAD CATALOG ======
(async ()=>{
  const res = await fetch("catalog.json");
  CATALOG = await res.json();
  chat("Dobby","‚úÖ Catalog ready ("+CATALOG.length+" movies). I learn from your likes ‚ô•");
})();

// ====== LLM ======
async function llm(messages){
  const r=await fetch("https://api.fireworks.ai/inference/v1/chat/completions",{
    method:"POST",
    headers:{ "Authorization":`Bearer ${FIREWORKS_KEY}`,"Content-Type":"application/json" },
    body:JSON.stringify({model:FIREWORKS_MODEL,messages,temperature:0.2})
  });
  return (await r.json()).choices[0].message.content;
}

// ====== ANALYSIS ======
async function analyze(q){
return JSON.parse(
  (await llm([
    {role:"system",content:`Return only JSON: { genre, language, year_after, min_rating, theme, summary }`},
    {role:"user",content:q}
  ])).replace(/```/g,"")
);
}

// ====== TASTE PROFILE A ======
async function rank(list, query){
  const HARDCORE = ["revenge","hitman","spy","assassin","war","brutal","cartel"];
  list=list.map(m=>{
    let bonus=0;
    const d=(m.description||"").toLowerCase();
    const g=(m.genres||[]).join(" ").toLowerCase();
    if(HARDCORE.some(t=>d.includes(t))) bonus+=20;
    if(HARDCORE.some(t=>g.includes(t))) bonus+=15;
    if(d.includes("revenge")) bonus+=25;
    return {...m,_tasteBonus:bonus};
  });

  if(list.length<30)
    return list.sort((a,b)=>(b._tasteBonus||0)-(a._tasteBonus||0));

  let scored="";
  try{
    scored = await llm([
      {role:"system",content:`Return ONLY JSON ranking: [{"id":"tt123","score":90}]`},
      {role:"user",content:`Rank relevance for: "${query}"\nMovies:${JSON.stringify(list.slice(0,60))}`}
    ]);
  }catch(e){
    return list.sort((a,b)=>(b._tasteBonus||0)-(a._tasteBonus||0));
  }

  let parsed = JSON.parse(scored.replace(/```/g,""));
  const map = new Map(parsed.map(s=>[s.id,s.score]));
  return list.map(m=>({...m,_score:(map.get(m.id)||0)+(m._tasteBonus||0)}))
             .sort((a,b)=>b._score-a._score);
}

// ====== FILTER ======
function filter(list,f){
  return list.filter(m=>{
    if(f.genre && !(m.genres||[]).join().toLowerCase().includes(f.genre.toLowerCase())) return false;
    if(f.language && !(m.spokenLanguages||[]).join().toLowerCase().includes(f.language.toLowerCase())) return false;
    if(f.year_after && (m.startYear||0) < f.year_after) return false;
    if(f.min_rating && (m.averageRating||0) < f.min_rating) return false;
    return true;
  });
}

// ====== ASK ======
async function ask(){
  const q=document.getElementById("userInput").value.trim();
  if(!q) return;
  chat("You",q);

  const f = await analyze(q);
  chat("Dobby","üîç "+f.summary);

  let pool = filter(CATALOG,f);
  if(pool.length===0){ chat("Dobby","üö´ No results"); return; }

  let ranked=await rank(pool,q);
  showMovies(ranked);
  chat("Dobby","‚úÖ Done ("+ranked.length+" found).");
}

document.getElementById("send").onclick = ask;
document.getElementById("userInput").onkeydown=e=>{if(e.key==="Enter")ask()};
</script>
</body>
</html>
